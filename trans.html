<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Hello World!</title>
        <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
        <meta
            http-equiv="Content-Security-Policy"
            content="script-src 'self' 'unsafe-inline';"
        />
    </head>
    <body
        style="
            overflow: hidden;
            margin: 0;
            padding: 0;
            position: relative;
            width: 200px;
            height: 200px;
        "
    >
        <div
            style="
                position: absolute;
                top: 155px;
                z-index: 4;
                width: 190px;
                text-align: center;
                left: 5px;
                border-radius: 5px;
            "
        >
            <div
                id="label"
                style="
                    background: rgba(10, 10, 10, 0.7);
                    border-radius: 4px;

                    color: white;
                    box-shadow: 1px 1px black;
                    text-align: left;
                    font-family: monospace;
                    font-size: 15px;

                    display: grid;
                    grid-template-columns: 45px 1fr;
                    grid-template-rows: 1fr 1fr auto;
                    gap: 0px 0px;
                    grid-template-areas: 'block colorName' 'block color' 'hexs hexs';

                "
            >
                <div
                    style="
                        grid-area: block;
                        width: 40px;
                        height: 40px;
                        font-size: 32px;
                    "
                    id="block"
                >
                    Aa
                </div>
                <span
                    style="
                        opacity: 0.7;
                        grid-area: colorName;
                        word-wrap: nowrap;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana,
                            sans-serif;
                    "
                    id="colorName"
                    >______</span
                >
                <span
                    style="grid-area: color; text-transform: uppercase;"
                    id="color"
                    >______</span
                >
                <div
                style="
                    grid-area: hexs;                    
                "
                id="hexs"
                >
                
            </div>
            </div>
        </div>
        <canvas
            id="myCanvas"
            width="400"
            height="400"
            style="
                transform: scale(0.5);
                image-rendering: pixelated;
                transform-origin: top left;
            "
        ></canvas>
        <canvas
            id="tempCanvas"
            width="50"
            height="50"
            style="
                display: none;
                image-rendering: pixelated;
                transform: scale(10);
                border: 1px red solid;
            "
        ></canvas>
    </body>
    <script>
        const nextPower = (n) => {
            let count = 0;

            while (n != 0) {
                n >>= 1;
                count += 1;
            }

            return 1 << count;
        };

        const isBright = (color) => {
            let r = 1,
                g = 1,
                b = 1,
                hsp;
            // Check the format of the color, HEX or RGB?
            if (color.match(/^rgb/)) {
                // If RGB --> store the red, green, blue values in separate variables
                let colors = color.match(
                    /^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/
                );
                if (colors) {
                    if (colors?.length > 2) {
                        r = colors[1];
                        g = colors[2];
                        b = colors[3];
                    }
                } else {
                    return false;
                }
            } else {
                // If hex --> Convert it to RGB: http://gist.github.com/983661
                let colors = +(
                    "0x" +
                    color.slice(1).replace(color.length < 5 && /./g, "$&$&")
                );

                r = colors >> 16;
                g = (colors >> 8) & 255;
                b = colors & 255;
            }

            // HSP (Highly Sensitive Poo) equation from http://alienryderflex.com/hsp.html
            hsp = Math.sqrt(
                0.299 * (r * r) + 0.587 * (g * g) + 0.114 * (b * b)
            );

            // Using the HSP value, determine whether the color is light or dark
            return hsp > 127.5;
        };

        const canvas = document.getElementById("myCanvas");

        const ctx = canvas.getContext("2d");

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.ceil(canvas.width * 0.45);

        const tempCanvas = document.getElementById("tempCanvas");
        const tempCtx = tempCanvas.getContext("2d");

        // window.w = 20;
        // window.h = 20;
        // document.addEventListener("keypress", (e) => {
        //     if (e.key === "w") {
        //         w++;
        //     }
        //     if (e.key === "q") {
        //         w--;
        //     }
        // });

        document.addEventListener("keydown", (e) => {
            window.ipcRenderer.send("down", e.key);
        });
        document.addEventListener("keyup", (e) => {
            window.ipcRenderer.send("up", e.key);
        });

        window.ipcRenderer.on("action-update-label", (event, arg) => {
            
            canvas.width = canvas.width;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
            ctx.lineWidth = 16;
            ctx.strokeStyle = `black`;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
            ctx.lineWidth = 12;
            ctx.strokeStyle = `white`;

            ctx.stroke();

            ctx.save();

            const imgData = ctx.createImageData(
                arg.dimension.width,
                arg.dimension.height
            );
            const powerWidth = nextPower(arg.dimension.width);
            for (let x = 0; x < arg.dimension.width; x++) {
                for (let y = 0; y < arg.dimension.height; y++) {
                    const i = y * (arg.dimension.width * 4) + x * 4;
                    const j = y * (powerWidth * 4) + x * 4;
                    imgData.data[i] = arg.img[j + 2];
                    imgData.data[i + 1] = arg.img[j + 1];
                    imgData.data[i + 2] = arg.img[j];
                    imgData.data[i + 3] = arg.img[j + 3];
                }
            }

            // for (let i = 0, j = 0; i < arg.img.length; i) {
            //     imgData.data[i] = arg.img[i + 2];
            //     imgData.data[i + 1] = arg.img[i + 1];
            //     imgData.data[i + 2] = arg.img[i];
            //     imgData.data[i + 3] = arg.img[i + 3];
            //     i += 4;
            //     // j += 3;
            // }
            tempCanvas.width = arg.dimension.width;
            tempCanvas.height = arg.dimension.height;
            tempCtx.putImageData(imgData, 0, 0);

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
            ctx.clip();

            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(
                tempCanvas,
                0,
                0,
                tempCanvas.width,
                tempCanvas.height,
                0,
                0,
                canvas.width,
                canvas.height
            );

            ctx.beginPath();
            const pixelDimension = canvas.width / tempCanvas.width;
            for (
                let x = pixelDimension - 1;
                x <= canvas.width;
                x += pixelDimension
            ) {
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                for (
                    let y = pixelDimension - 1;
                    y <= canvas.height;
                    y += pixelDimension
                ) {
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                }
            }

            ctx.strokeStyle = "white";
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.beginPath();
            const near = pixelDimension * (tempCanvas.width / 2);
            const far = pixelDimension * (tempCanvas.width / 2 + 1);
            ctx.moveTo(near, near);
            ctx.lineTo(near, far);
            ctx.lineTo(far, far);
            ctx.lineTo(far, near);
            ctx.lineTo(near, near);
            ctx.strokeStyle = "black";
            ctx.lineWidth = 6;
            ctx.stroke();

            let colorName = document.getElementById("colorName");
            colorName.innerHTML = arg.colorName.name;
            let color = document.getElementById("color");
            color.innerHTML = `#${arg.color}`;
            let block = document.getElementById("block");
            block.style.background = `#${arg.color}`;
            block.style.color = isBright(arg.color) ? "black" : "white";

            let label = document.getElementById("label");
            label.style.color = `white`;
            label.style.backgroundColor = `#${arg.backgroundColor}`;

            let colorHexs = document.getElementById("hexs");
            const hexesStr = arg.colorHexs.map(
                hex => `<div style=" 
                outline: 1px white solid;
                border: 1px black solid;
                display: inline-block; width: 10px; height: 10px; margin: 4px; background: #${hex}" ></div>`
            ).join('');
            colorHexs.innerHTML = hexesStr;

        });
    </script>
</html>
